<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Administrador - MEP Costa Rica</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Temas Accesibles -->
    <link rel="stylesheet" href="css/temas-accesibles.css" />

    <style>
      .dashboard-header {
        background: linear-gradient(135deg, #002b7f 0%, #004494 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
      }

      .stats-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-5px);
      }

      .nav-tabs .nav-link {
        border: none;
        border-radius: 10px 10px 0 0;
        margin-right: 5px;
        font-weight: 600;
      }

      .nav-tabs .nav-link.active {
        background-color: var(--cr-azul);
        color: white;
      }

      .table-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .btn-cr-primary {
        background: linear-gradient(135deg, var(--cr-azul) 0%, #004494 100%);
        border: none;
        color: white;
        font-weight: 600;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
      }

      .btn-cr-primary:hover {
        background: linear-gradient(135deg, #004494 0%, var(--cr-azul) 100%);
        transform: translateY(-2px);
        color: white;
      }

      .btn-cr-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        font-weight: 600;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
      }

      .btn-cr-success:hover {
        background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        transform: translateY(-2px);
        color: white;
      }

      .modal-header {
        background: linear-gradient(135deg, var(--cr-azul) 0%, #004494 100%);
        color: white;
        border-radius: 10px 10px 0 0;
      }

      .alert-container {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1060;
        width: 300px;
      }

      @media (max-width: 768px) {
        .table-container {
          padding: 1rem;
        }
        .alert-container {
          width: calc(100% - 40px);
          right: 20px;
          left: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Alertas Container -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Header Dashboard -->
    <div class="dashboard-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="display-6 fw-bold mb-2">
              <i class="fas fa-user-shield me-3"></i>Panel de Administrador
            </h1>
            <p class="mb-0 opacity-75">
              <i class="fas fa-school me-2"></i>
              <span id="centroEducativo">Centro Educativo</span>
            </p>
          </div>
          <div class="col-md-6 text-end">
            <div class="d-flex align-items-center justify-content-end">
              <div class="me-4">
                <div class="fw-bold" id="nombreUsuario">Administrador</div>
                <small class="opacity-75">
                  <i class="fas fa-calendar me-1"></i>
                  <span id="fechaActual"></span>
                </small>
              </div>
              <button id="logoutBtn" class="btn btn-outline-light">
                <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesi√≥n
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="container-fluid">
      <!-- Estad√≠sticas R√°pidas -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card stats-card text-center p-3">
            <div class="card-body">
              <i class="fas fa-chalkboard-teacher fa-2x text-primary mb-2"></i>
              <h5 class="card-title">Docentes</h5>
              <h3 class="text-primary" id="totalDocentes">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card text-center p-3">
            <div class="card-body">
              <i class="fas fa-users fa-2x text-success mb-2"></i>
              <h5 class="card-title">Padres</h5>
              <h3 class="text-success" id="totalPadres">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card text-center p-3">
            <div class="card-body">
              <i class="fas fa-user-graduate fa-2x text-warning mb-2"></i>
              <h5 class="card-title">Alumnos</h5>
              <h3 class="text-warning" id="totalAlumnos">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card text-center p-3">
            <div class="card-body">
              <i class="fas fa-box fa-2x text-info mb-2"></i>
              <h5 class="card-title">Materiales</h5>
              <h3 class="text-info" id="totalMateriales">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Navegaci√≥n por Pesta√±as -->
      <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="docentes-tab"
            data-bs-toggle="tab"
            data-bs-target="#docentes"
            type="button"
            role="tab"
            aria-controls="docentes"
            aria-selected="true"
          >
            <i class="fas fa-chalkboard-teacher me-2"></i>Gesti√≥n de Docentes
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="padres-tab"
            data-bs-toggle="tab"
            data-bs-target="#padres"
            type="button"
            role="tab"
            aria-controls="padres"
            aria-selected="false"
          >
            <i class="fas fa-users me-2"></i>Gesti√≥n de Padres
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="estudiantes-tab"
            data-bs-toggle="tab"
            data-bs-target="#estudiantes"
            type="button"
            role="tab"
            aria-controls="estudiantes"
            aria-selected="false"
          >
            <i class="fas fa-user-graduate me-2"></i>Gesti√≥n de Estudiantes
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="usuarios-tab"
            data-bs-toggle="tab"
            data-bs-target="#usuarios"
            type="button"
            role="tab"
            aria-controls="usuarios"
            aria-selected="false"
          >
            <i class="fas fa-user-friends me-2"></i>Todos los Usuarios
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="materiales-tab"
            data-bs-toggle="tab"
            data-bs-target="#materiales"
            type="button"
            role="tab"
            aria-controls="materiales"
            aria-selected="false"
          >
            <i class="fas fa-box me-2"></i>Materiales
          </button>
        </li>
      </ul>

      <!-- Contenido de las Pesta√±as -->
      <div class="tab-content" id="adminTabsContent">
        <!-- GESTI√ìN DE DOCENTES -->
        <div class="tab-pane fade show active" id="docentes" role="tabpanel">
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">
                <i class="fas fa-chalkboard-teacher me-2"></i>Gesti√≥n de
                Docentes
              </h4>
              <button
                class="btn btn-cr-success"
                data-bs-toggle="modal"
                data-bs-target="#modalAgregarDocente"
              >
                <i class="fas fa-plus me-2"></i>Agregar Docente
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Estado</th>
                    <th>√öltimo Login</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaDocentes">
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <i class="fas fa-spinner fa-spin me-2"></i>Cargando
                      docentes...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- GESTI√ìN DE PADRES -->
        <div class="tab-pane fade" id="padres" role="tabpanel">
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">
                <i class="fas fa-users me-2"></i>Gesti√≥n de Padres de Familia
              </h4>
              <button
                class="btn btn-cr-success"
                data-bs-toggle="modal"
                data-bs-target="#modalAgregarPadre"
              >
                <i class="fas fa-plus me-2"></i>Agregar Padre
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Hijos</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaPadres">
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <i class="fas fa-spinner fa-spin me-2"></i>Cargando
                      padres...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- GESTI√ìN DE ESTUDIANTES -->
        <div class="tab-pane fade" id="estudiantes" role="tabpanel">
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">
                <i class="fas fa-user-graduate me-2"></i>Estudiantes
              </h4>
              <button
                class="btn btn-cr-success"
                onclick="showCreateStudentModal()"
              >
                <i class="fas fa-plus me-2"></i>Nuevo Estudiante
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-primary">
                  <tr>
                    <th>Nombre</th>
                    <th>C√©dula</th>
                    <th>Nivel/Grado</th>
                    <th>Padre/Madre</th>
                    <th>Centro Educativo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaEstudiantes">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <i class="fas fa-spinner fa-spin me-2"></i>Cargando
                      estudiantes...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TODOS LOS USUARIOS -->
        <div class="tab-pane fade" id="usuarios" role="tabpanel">
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">
                <i class="fas fa-user-friends me-2"></i>Todos los Usuarios del
                Centro
              </h4>
              <div class="d-flex gap-2">
                <select
                  id="filtroRol"
                  class="form-select"
                  style="width: auto"
                  title="Filtrar por rol"
                >
                  <option value="">Todos los roles</option>
                  <option value="docente">Docentes</option>
                  <option value="padre">Padres</option>
                  <option value="alumno">Alumnos</option>
                </select>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaUsuarios">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <i class="fas fa-spinner fa-spin me-2"></i>Cargando
                      usuarios...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- MATERIALES -->
        <div class="tab-pane fade" id="materiales" role="tabpanel">
          <div class="table-container">
            <h4 class="mb-4">
              <i class="fas fa-box me-2"></i>Materiales Disponibles
            </h4>

            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Informaci√≥n:</strong> Estos son los materiales que los
              docentes pueden usar en sus listas.
            </div>

            <form id="formMateriales">
              <div id="materialesContainer" class="row">
                <div class="col-12 text-center py-4">
                  <i class="fas fa-spinner fa-spin me-2"></i>Cargando
                  materiales...
                </div>
              </div>
              <div class="mt-4">
                <button type="submit" class="btn btn-cr-primary">
                  <i class="fas fa-save me-2"></i>Guardar Configuraci√≥n
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal agregar docente -->
    <div
      class="modal fade"
      id="modalAgregarDocente"
      tabindex="-1"
      aria-labelledby="modalAgregarDocenteLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAgregarDocenteLabel">
              <i class="fas fa-chalkboard-teacher me-2"></i>Agregar Docente
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formAgregarDocente">
              <div class="mb-3">
                <label for="docenteNombre" class="form-label">
                  <i class="fas fa-user me-2"></i>Nombre Completo
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="docenteNombre"
                  required
                  placeholder="Ej: Mar√≠a Gonz√°lez P√©rez"
                />
              </div>
              <div class="mb-3">
                <label for="docenteCorreo" class="form-label">
                  <i class="fas fa-envelope me-2"></i>Correo Electr√≥nico
                </label>
                <input
                  type="email"
                  class="form-control"
                  id="docenteCorreo"
                  required
                  placeholder="nombre@mep.go.cr"
                />
                <div class="form-text">
                  Debe ser un correo del dominio @mep.go.cr
                </div>
              </div>
              <div class="mb-3">
                <label for="docentePassword" class="form-label">
                  <i class="fas fa-lock me-2"></i>Contrase√±a Temporal
                </label>
                <input
                  type="password"
                  class="form-control"
                  id="docentePassword"
                  required
                  placeholder="M√≠nimo 6 caracteres"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="formAgregarDocente"
              class="btn btn-cr-primary"
            >
              <i class="fas fa-save me-2"></i>Crear Docente
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Estudiantes vinculados al Padre -->
    <div
      class="modal fade"
      id="modalEstudiantesPadre"
      tabindex="-1"
      aria-labelledby="modalEstudiantesPadreLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalEstudiantesPadreLabel">
              <i class="fas fa-children me-2"></i>Estudiantes del Padre
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <div id="contenidoEstudiantesPadre">
              <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin me-2"></i>Cargando‚Ä¶
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal agregar padre -->
    <div
      class="modal fade"
      id="modalAgregarPadre"
      tabindex="-1"
      aria-labelledby="modalAgregarPadreLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAgregarPadreLabel">
              <i class="fas fa-users me-2"></i>Agregar Padre de Familia
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formAgregarPadre">
              <!-- Datos del Padre -->
              <div class="card mb-4">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    Datos del Padre de Familia
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="nombrePadre" class="form-label"
                        >Nombre Completo *</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="nombrePadre"
                        required
                        placeholder="Ej: Juan P√©rez Morales"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="cedulaPadre" class="form-label"
                        >C√©dula *</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="cedulaPadre"
                        required
                        placeholder="Ej: 1-2345-6789"
                        pattern="[0-9\-]+"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="telefonoPadre" class="form-label"
                        >Tel√©fono *</label
                      >
                      <input
                        type="tel"
                        class="form-control"
                        id="telefonoPadre"
                        required
                        placeholder="Ej: 8888-8888 o 88888888"
                        pattern="^(?:\\d{8}|\\d{4}-\\d{4})$"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="correoPadre" class="form-label"
                        >Correo Electr√≥nico *</label
                      >
                      <input
                        type="email"
                        class="form-control"
                        id="correoPadre"
                        required
                        placeholder="Ej: padre@email.com"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="contrase√±aPadre" class="form-label"
                        >Contrase√±a *</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        id="contrase√±aPadre"
                        required
                        placeholder="M√≠nimo 6 caracteres"
                        minlength="6"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="confirmarContrase√±a" class="form-label"
                        >Confirmar Contrase√±a *</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        id="confirmarContrase√±a"
                        required
                        placeholder="Repetir contrase√±a"
                      />
                    </div>
                    <div class="col-12 mb-3">
                      <label for="direccionPadre" class="form-label"
                        >Direcci√≥n</label
                      >
                      <textarea
                        class="form-control"
                        id="direccionPadre"
                        rows="2"
                        placeholder="Direcci√≥n completa (opcional)"
                      ></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Datos de los Estudiantes -->
              <div class="card mb-4">
                <div
                  class="card-header bg-light d-flex justify-content-between align-items-center"
                >
                  <h6 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Datos de los Estudiantes
                  </h6>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    id="btnAgregarEstudiante"
                  >
                    <i class="fas fa-plus me-1"></i>
                    Agregar Estudiante
                  </button>
                </div>
                <div class="card-body">
                  <div id="contenedorEstudiantes">
                    <!-- Primer estudiante por defecto -->
                    <div
                      class="estudiante-item border rounded p-3 mb-3"
                      data-index="0"
                    >
                      <div
                        class="d-flex justify-content-between align-items-center mb-3"
                      >
                        <h6 class="mb-0">
                          <i class="fas fa-child me-2"></i>
                          Estudiante #1
                        </h6>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-danger d-none eliminar-estudiante"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Nombre Completo *</label>
                          <input
                            type="text"
                            class="form-control"
                            name="nombreEstudiante"
                            required
                            placeholder="Ej: Mar√≠a P√©rez Gonz√°lez"
                          />
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label"
                            >C√©dula del Estudiante *</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            name="cedulaEstudiante"
                            required
                            placeholder="Ej: 1-2345-6789"
                            pattern="[0-9\-]+"
                          />
                        </div>
                        <div class="col-md-4 mb-3">
                          <label class="form-label">Nivel *</label>
                          <select
                            class="form-select"
                            name="nivelEstudiante"
                            required
                          >
                            <option value="">Seleccionar nivel</option>
                            <option value="Preescolar">Preescolar</option>
                            <option value="Primaria">Primaria</option>
                            <option value="Secundaria">Secundaria</option>
                          </select>
                        </div>
                        <div class="col-md-4 mb-3">
                          <label class="form-label">Grado *</label>
                          <select
                            class="form-select"
                            name="gradoEstudiante"
                            required
                          >
                            <option value="">Seleccionar grado</option>
                            <option value="Kinder">Kinder</option>
                            <option value="Preparatoria">Preparatoria</option>
                            <option value="1¬∞">1¬∞</option>
                            <option value="2¬∞">2¬∞</option>
                            <option value="3¬∞">3¬∞</option>
                            <option value="4¬∞">4¬∞</option>
                            <option value="5¬∞">5¬∞</option>
                            <option value="6¬∞">6¬∞</option>
                            <option value="7¬∞">7¬∞</option>
                            <option value="8¬∞">8¬∞</option>
                            <option value="9¬∞">9¬∞</option>
                            <option value="10¬∞">10¬∞</option>
                            <option value="11¬∞">11¬∞</option>
                          </select>
                        </div>
                        <div class="col-md-4 mb-3">
                          <label class="form-label">Fecha de Nacimiento</label>
                          <input
                            type="date"
                            class="form-control"
                            name="fechaNacimientoEstudiante"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Puedes agregar hasta 15 estudiantes. Al menos uno es
                    requerido.
                  </small>
                </div>
              </div>

              <!-- Mensaje de error/√©xito -->
              <div id="mensajeRegistroPadreAdmin" class="alert d-none"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="formAgregarPadre"
              class="btn btn-cr-primary"
            >
              <i class="fas fa-save me-2"></i>Crear Padre
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal confirmar eliminaci√≥n -->
    <div
      class="modal fade"
      id="modalConfirmarEliminacion"
      tabindex="-1"
      aria-labelledby="modalConfirmarEliminacionLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="modalConfirmarEliminacionLabel">
              <i class="fas fa-exclamation-triangle me-2"></i>Confirmar
              Eliminaci√≥n
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">¬øEst√° seguro que desea eliminar este usuario?</p>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Atenci√≥n:</strong> Esta acci√≥n no se puede deshacer.
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="confirmarEliminar">
              <i class="fas fa-trash me-2"></i>Eliminar Usuario
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Auth Functions -->
    <script src="auth-global.js"></script>

    <script>
      // Verificar autenticaci√≥n al cargar la p√°gina
      if (!isAuthenticated()) {
        alert("No tienes una sesi√≥n activa. Ser√°s redirigido al login.");
        window.location.href = "login.html";
      }

      // Variables globales
      let docentes = [];
      let padres = [];
      let estudiantes = [];
      let usuarios = [];
      let materiales = [];
      let centroEducativoId = null;
      let usuarioEliminando = null;

      // Funci√≥n global para logout
      window.logoutUsuario = logoutUsuario;

      // Funci√≥n para mostrar alertas
      function mostrarAlerta(mensaje, tipo = "success") {
        const alertContainer = document.getElementById("alertContainer");
        const alertId = "alert-" + Date.now();

        const alertHTML = `
          <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show" role="alert">
            <i class="fas fa-${
              tipo === "success" ? "check-circle" : "exclamation-triangle"
            } me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;

        alertContainer.insertAdjacentHTML("beforeend", alertHTML);

        // Auto-remove despu√©s de 5 segundos
        setTimeout(() => {
          const alert = document.getElementById(alertId);
          if (alert) {
            alert.remove();
          }
        }, 5000);
      }

      // Inicializar datos del usuario
      async function inicializarUsuario() {
        try {
          const perfil = await authenticatedGet("/api/auth/perfil");

          if (perfil && perfil.usuario) {
            const { nombre, centroEducativo } = perfil.usuario;

            document.getElementById("nombreUsuario").textContent =
              nombre || "Administrador";

            if (centroEducativo) {
              centroEducativoId = centroEducativo._id || centroEducativo;

              const centroNombre = centroEducativo.nombre || "Centro Educativo";
              document.getElementById("centroEducativo").textContent =
                centroNombre;
            }
          }
        } catch (error) {
          console.error("Error obteniendo perfil:", error);
          mostrarAlerta("Error al cargar informaci√≥n del usuario", "danger");
        }
      }

      // Cargar estad√≠sticas
      async function cargarEstadisticas() {
        try {
          const params = centroEducativoId
            ? `?centroEducativo=${centroEducativoId}`
            : "";

          console.log("üìä Cargando estad√≠sticas con par√°metros:", params);

          // Cargar usuarios del centro
          let usuariosResponse = await authenticatedGet(
            `/api/usuarios${params}`
          );

          let todosUsuarios = [];
          if (
            usuariosResponse &&
            usuariosResponse.success &&
            usuariosResponse.data
          ) {
            todosUsuarios = usuariosResponse.data.docs || usuariosResponse.data;
            console.log("üë• Usuarios con filtro:", todosUsuarios.length);

            let docentesCount = todosUsuarios.filter(
              (u) => u.rol === "docente"
            ).length;
            let padresCount = todosUsuarios.filter(
              (u) => u.rol === "padre"
            ).length;

            console.log("üë®‚Äçüè´ Docentes con filtro:", docentesCount);
            console.log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Padres con filtro:", padresCount);

            // Si no hay padres con el filtro pero hay centroEducativoId, buscar sin filtro
            if (padresCount === 0 && centroEducativoId) {
              console.log(
                "üîÑ No hay padres con filtro, buscando sin filtro para estad√≠sticas..."
              );
              const usuariosSinFiltro = await authenticatedGet(`/api/usuarios`);

              if (
                usuariosSinFiltro &&
                usuariosSinFiltro.success &&
                usuariosSinFiltro.data
              ) {
                const todosUsuariosSinFiltro =
                  usuariosSinFiltro.data.docs || usuariosSinFiltro.data;

                // Actualizar solo padres desde la b√∫squeda sin filtro, mantener docentes con filtro
                padresCount = todosUsuariosSinFiltro.filter(
                  (u) => u.rol === "padre"
                ).length;
                console.log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Padres sin filtro encontrados:", padresCount);

                // Si tampoco hay docentes con filtro, usar los sin filtro
                if (docentesCount === 0) {
                  docentesCount = todosUsuariosSinFiltro.filter(
                    (u) => u.rol === "docente"
                  ).length;
                  console.log("üë®‚Äçüè´ Docentes sin filtro:", docentesCount);
                }
              }
            }

            console.log(
              "üìä Actualizando tarjetas - Docentes:",
              docentesCount,
              "Padres:",
              padresCount
            );
            document.getElementById("totalDocentes").textContent =
              docentesCount;
            document.getElementById("totalPadres").textContent = padresCount;
          }

          // Cargar estudiantes desde el endpoint espec√≠fico
          let estudiantesResponse = await authenticatedGet(
            `/api/usuarios/all-estudiantes${params}`
          );
          if (
            estudiantesResponse &&
            estudiantesResponse.success &&
            estudiantesResponse.data
          ) {
            let estudiantesData =
              estudiantesResponse.data.docs || estudiantesResponse.data;

            // Fallback: si no hay estudiantes con filtro, consultar sin filtro
            if (estudiantesData.length === 0 && centroEducativoId) {
              const sinFiltro = await authenticatedGet(
                `/api/usuarios/all-estudiantes`
              );
              if (sinFiltro && sinFiltro.success && sinFiltro.data) {
                estudiantesData = sinFiltro.data.docs || sinFiltro.data;
              }
            }

            document.getElementById("totalAlumnos").textContent =
              estudiantesData.length;
          } else {
            document.getElementById("totalAlumnos").textContent = 0;
          }

          // Cargar materiales
          const materialesResponse = await authenticatedGet("/api/materiales");
          if (materialesResponse && materialesResponse.data) {
            const materialesData =
              materialesResponse.data.docs || materialesResponse.data;
            document.getElementById("totalMateriales").textContent =
              materialesData.length;
          }
        } catch (error) {
          console.error("Error cargando estad√≠sticas:", error);
        }
      }

      // Cargar docentes
      async function cargarDocentes() {
        try {
          const params = centroEducativoId
            ? `?centroEducativo=${centroEducativoId}`
            : "";

          let result = await authenticatedGet(`/api/usuarios${params}`);

          if (result && result.success && result.data) {
            const todosUsuarios = result.data.docs || result.data;

            docentes = todosUsuarios.filter(
              (usuario) => usuario.rol === "docente"
            );

            // Si no encontramos docentes con el filtro, intentar sin filtro
            if (docentes.length === 0 && centroEducativoId) {
              console.log(
                "üîÑ No se encontraron docentes con filtro, intentando sin filtro..."
              );
              result = await authenticatedGet(`/api/usuarios`);

              if (result && result.success && result.data) {
                const todosUsuariosSinFiltro = result.data.docs || result.data;
                docentes = todosUsuariosSinFiltro.filter(
                  (usuario) => usuario.rol === "docente"
                );
                console.log(
                  "üë®‚Äçüè´ Docentes encontrados (sin filtro):",
                  docentes.length
                );
              }
            }

            renderDocentes();
          } else {
            mostrarAlerta("No se pudieron cargar los docentes", "warning");
          }
        } catch (error) {
          console.error("Error cargando docentes:", error);
          mostrarAlerta("Error al cargar docentes", "danger");
        }
      }

      // Render docentes
      function renderDocentes() {
        const tbody = document.getElementById("tablaDocentes");

        if (docentes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-4">
                <i class="fas fa-inbox me-2"></i>No hay docentes registrados
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = docentes
          .map(
            (docente) => `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-chalkboard-teacher me-2 text-primary"></i>
                ${docente.nombre}
              </div>
            </td>
            <td>${docente.correo}</td>
            <td>
              <span class="badge bg-${
                docente.estado === "activo" ? "success" : "danger"
              }">
                ${docente.estado === "activo" ? "Activo" : "Inactivo"}
              </span>
            </td>
            <td>
              ${
                docente.fechaUltimoLogin
                  ? new Date(docente.fechaUltimoLogin).toLocaleDateString()
                  : "Nunca"
              }
            </td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-warning" onclick="toggleEstadoUsuario('${
                  docente._id
                }', '${docente.estado}')" title="${
              docente.estado === "activo" ? "Desactivar" : "Activar"
            }">
                  <i class="fas fa-${
                    docente.estado === "activo" ? "pause" : "play"
                  }"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmarEliminarUsuario('${
                  docente._id
                }', '${docente.nombre}')" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Cargar padres
      async function cargarPadres() {
        try {
          console.log("üîç Iniciando carga de padres...");

          // Primer intento: con filtro de centro educativo si existe
          let params = centroEducativoId
            ? `?centroEducativo=${centroEducativoId}`
            : "";
          console.log("üìç Par√°metros:", params);
          console.log("üè´ Centro Educativo ID:", centroEducativoId);

          let result = await authenticatedGet(`/api/usuarios${params}`);
          console.log("üìä Respuesta completa de usuarios:", result);

          if (result && result.success && result.data) {
            const todosUsuarios = result.data.docs || result.data;
            console.log("üë• Total usuarios recibidos:", todosUsuarios.length);

            padres = todosUsuarios.filter((usuario) => usuario.rol === "padre");
            console.log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Padres filtrados (con filtro):", padres.length);

            // Si no encontramos padres con el filtro, intentar sin filtro
            if (padres.length === 0 && centroEducativoId) {
              console.log(
                "ÔøΩ No se encontraron padres con filtro, intentando sin filtro..."
              );
              result = await authenticatedGet(`/api/usuarios`);

              if (result && result.success && result.data) {
                const todosUsuariosSinFiltro = result.data.docs || result.data;
                padres = todosUsuariosSinFiltro.filter(
                  (usuario) => usuario.rol === "padre"
                );
                console.log(
                  "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Padres encontrados (sin filtro):",
                  padres.length
                );
              }
            }

            console.log(
              "ÔøΩüìã Lista final de padres:",
              padres.map((p) => p.nombre)
            );
            renderPadres();
          } else {
            console.error("‚ùå Error en respuesta:", result);
            mostrarAlerta("No se pudieron cargar los padres", "warning");
          }
        } catch (error) {
          console.error("Error cargando padres:", error);
          mostrarAlerta("Error al cargar padres", "danger");
        }
      }

      // Render padres
      function renderPadres() {
        console.log("üé® Iniciando render de padres...");
        const tbody = document.getElementById("tablaPadres");
        console.log("üìç Elemento tbody encontrado:", !!tbody);
        console.log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Cantidad de padres a renderizar:", padres.length);

        if (padres.length === 0) {
          console.log("‚ö†Ô∏è No hay padres para mostrar");
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-4">
                <i class="fas fa-inbox me-2"></i>No hay padres registrados
              </td>
            </tr>
          `;
          return;
        }

        console.log(
          "‚úÖ Renderizando padres:",
          padres.map((p) => p.nombre)
        );
        tbody.innerHTML = padres
          .map(
            (padre) => `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-users me-2 text-success"></i>
                ${padre.nombre}
              </div>
            </td>
            <td>${padre.correo}</td>
            <td>
              ${
                (Array.isArray(padre.estudiantes) &&
                  padre.estudiantes.length > 0) ||
                (Array.isArray(padre.hijos) && padre.hijos.length > 0)
                  ? (() => {
                      const count =
                        (Array.isArray(padre.estudiantes) &&
                          padre.estudiantes.length) ||
                        (Array.isArray(padre.hijos) ? padre.hijos.length : 0);
                      return `<span class="badge bg-info">${count} hijo${
                        count > 1 ? "s" : ""
                      }</span>`;
                    })()
                  : '<span class="text-muted">Sin hijos registrados</span>'
              }
            </td>
            <td>
              <span class="badge bg-${
                padre.estado === "activo" ? "success" : "danger"
              }">
                ${padre.estado === "activo" ? "Activo" : "Inactivo"}
              </span>
            </td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="verEstudiantesPadre('${
                  padre._id
                }')" title="Ver estudiantes">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="toggleEstadoUsuario('${
                  padre._id
                }', '${padre.estado}')" title="${
              padre.estado === "activo" ? "Desactivar" : "Activar"
            }">
                  <i class="fas fa-${
                    padre.estado === "activo" ? "pause" : "play"
                  }"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmarEliminarUsuario('${
                  padre._id
                }', '${padre.nombre}')" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Ver estudiantes reales de un padre (filtrados por centro del admin si aplica)
      window.verEstudiantesPadre = async function (padreId) {
        try {
          // Abrir modal inmediatamente con loading
          const modalEl = document.getElementById("modalEstudiantesPadre");
          const modal = new bootstrap.Modal(modalEl);
          document.getElementById("contenidoEstudiantesPadre").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-spinner fa-spin me-2"></i>Cargando‚Ä¶
            </div>`;
          modal.show();

          // Buscar el padre en memoria
          let padre = padres.find((p) => p._id === padreId);
          if (!padre || !Array.isArray(padre.estudiantes)) {
            // Fallback: obtener datos completos del backend
            const resp = await authenticatedGet(`/api/usuarios/${padreId}`);
            if (resp && resp.success && resp.data) {
              padre = resp.data;
            }
          }

          const nombrePadre = padre?.nombre || "Padre";
          document.getElementById("modalEstudiantesPadreLabel").innerHTML = `
            <i class="fas fa-children me-2"></i>Estudiantes de ${nombrePadre}`;

          let lista = Array.isArray(padre?.estudiantes)
            ? padre.estudiantes
            : [];

          // Filtro por centro del administrador si est√° definido
          if (centroEducativoId) {
            lista = lista.filter((est) => {
              const ce = est.centroEducativo;
              const estCE = ce && (ce._id || ce);
              return estCE ? estCE === centroEducativoId : true; // si no tiene centro, lo mostramos igual
            });
          }

          if (lista.length === 0) {
            document.getElementById("contenidoEstudiantesPadre").innerHTML = `
              <div class="text-center py-4">
                <i class="fas fa-inbox me-2"></i>No hay estudiantes para mostrar${
                  centroEducativoId ? " en este centro" : ""
                }.
              </div>`;
            return;
          }

          // Render tabla con datos reales
          const rows = lista
            .map((e) => {
              const ce = e.centroEducativo;
              const ceNombre = ce?.nombre || "";
              return `
                <tr>
                  <td>${e.nombre || ""}</td>
                  <td>${e.cedula || ""}</td>
                  <td>${e.nivel || ""}</td>
                  <td>${e.grado || ""}</td>
                  <td>${ceNombre || "Sin asignar"}</td>
                </tr>`;
            })
            .join("");

          document.getElementById("contenidoEstudiantesPadre").innerHTML = `
            <div class="table-responsive">
              <table class="table table-striped align-middle">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>C√©dula</th>
                    <th>Nivel</th>
                    <th>Grado</th>
                    <th>Centro</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>`;
        } catch (err) {
          console.error("Error mostrando estudiantes del padre:", err);
          document.getElementById("contenidoEstudiantesPadre").innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar estudiantes
            </div>`;
        }
      };

      // Cargar estudiantes
      async function cargarEstudiantes() {
        try {
          const params = centroEducativoId
            ? `?centroEducativo=${centroEducativoId}`
            : "";

          let result = await authenticatedGet(
            `/api/usuarios/all-estudiantes${params}`
          );

          if (result && result.success && result.data) {
            estudiantes = result.data.docs || result.data;

            // Fallback: si no se encontraron estudiantes con filtro, intentar sin filtro
            if (estudiantes.length === 0 && centroEducativoId) {
              const sinFiltro = await authenticatedGet(
                `/api/usuarios/all-estudiantes`
              );
              if (sinFiltro && sinFiltro.success && sinFiltro.data) {
                estudiantes = sinFiltro.data.docs || sinFiltro.data;
              }
            }
            renderEstudiantes();
          } else {
            mostrarAlerta("No se pudieron cargar los estudiantes", "warning");
          }
        } catch (error) {
          console.error("Error cargando estudiantes:", error);
          mostrarAlerta("Error al cargar estudiantes", "danger");
        }
      }

      // Render estudiantes
      function renderEstudiantes() {
        const tbody = document.getElementById("tablaEstudiantes");

        if (estudiantes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-4">
                <i class="fas fa-inbox me-2"></i>No hay estudiantes registrados
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = estudiantes
          .map(
            (estudiante) => `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-user-graduate me-2 text-warning"></i>
                ${estudiante.nombre}
              </div>
            </td>
            <td>${estudiante.cedula}</td>
            <td>
              <span class="badge bg-info">${estudiante.nivel}</span>
              <span class="badge bg-secondary">${estudiante.grado}</span>
            </td>
            <td>
              ${estudiante.padre ? estudiante.padre.nombre : "Sin asignar"}
              ${
                estudiante.padre
                  ? `<br><small class="text-muted">${estudiante.padre.correo}</small>`
                  : ""
              }
            </td>
            <td>
              ${
                estudiante.centroEducativo
                  ? estudiante.centroEducativo.nombre
                  : "Sin asignar"
              }
            </td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" onclick="editarEstudiante('${
                  estudiante._id
                }')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarEstudiante('${
                  estudiante._id
                }')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Cargar todos los usuarios
      async function cargarUsuarios() {
        try {
          const params = centroEducativoId
            ? `?centroEducativo=${centroEducativoId}`
            : "";

          const result = await authenticatedGet(`/api/usuarios${params}`);

          if (result && result.success && result.data) {
            usuarios = result.data.docs || result.data;

            renderUsuarios();
          } else {
            mostrarAlerta("No se pudieron cargar los usuarios", "warning");
          }
        } catch (error) {
          console.error("Error cargando usuarios:", error);
          mostrarAlerta("Error al cargar usuarios", "danger");
        }
      }

      // Render usuarios
      function renderUsuarios() {
        const tbody = document.getElementById("tablaUsuarios");
        const filtroRol = document.getElementById("filtroRol").value;

        let usuariosFiltrados = usuarios;
        if (filtroRol) {
          usuariosFiltrados = usuarios.filter((u) => u.rol === filtroRol);
        }

        if (usuariosFiltrados.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-4">
                <i class="fas fa-inbox me-2"></i>No hay usuarios ${
                  filtroRol ? "con el rol " + filtroRol : "registrados"
                }
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = usuariosFiltrados
          .map(
            (usuario) => `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-${getIconoRol(
                  usuario.rol
                )} me-2 text-${getColorRol(usuario.rol)}"></i>
                ${usuario.nombre}
              </div>
            </td>
            <td>${usuario.correo}</td>
            <td>
              <span class="badge bg-${getColorRol(usuario.rol)}">
                ${usuario.rol.charAt(0).toUpperCase() + usuario.rol.slice(1)}
              </span>
            </td>
            <td>
              <span class="badge bg-${
                usuario.estado === "activo" ? "success" : "danger"
              }">
                ${usuario.estado === "activo" ? "Activo" : "Inactivo"}
              </span>
            </td>
            <td>
              ${
                usuario.createdAt
                  ? new Date(usuario.createdAt).toLocaleDateString()
                  : "N/A"
              }
            </td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-warning" onclick="toggleEstadoUsuario('${
                  usuario._id
                }', '${usuario.estado}')" title="${
              usuario.estado === "activo" ? "Desactivar" : "Activar"
            }">
                  <i class="fas fa-${
                    usuario.estado === "activo" ? "pause" : "play"
                  }"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmarEliminarUsuario('${
                  usuario._id
                }', '${usuario.nombre}')" title="Eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Cargar materiales
      async function cargarMateriales() {
        try {
          const response = await authenticatedGet("/api/materiales");

          if (response && response.success && response.data) {
            materiales = response.data.docs || response.data;
            renderMateriales();
          } else {
            mostrarAlerta("No se pudieron cargar los materiales", "warning");
          }
        } catch (error) {
          console.error("Error cargando materiales:", error);
          mostrarAlerta("Error al cargar materiales", "danger");
        }
      }

      // Render materiales
      function renderMateriales() {
        const container = document.getElementById("materialesContainer");

        if (materiales.length === 0) {
          container.innerHTML = `
            <div class="col-12 text-center py-4">
              <i class="fas fa-inbox me-2"></i>No hay materiales disponibles
            </div>
          `;
          return;
        }

        container.innerHTML = materiales
          .map(
            (material) => `
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="material_${
                    material._id
                  }" 
                         ${material.disponibleParaDocentes ? "checked" : ""}>
                  <label class="form-check-label" for="material_${
                    material._id
                  }">
                    <strong>${material.nombre}</strong>
                  </label>
                </div>
                <small class="text-muted d-block mt-1">
                  Categor√≠a: ${material.categoria?.nombre || "Sin categor√≠a"}
                </small>
                ${
                  material.descripcion
                    ? `<p class="card-text mt-2 small">${material.descripcion}</p>`
                    : ""
                }
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Funciones auxiliares
      function getIconoRol(rol) {
        const iconos = {
          docente: "chalkboard-teacher",
          padre: "users",
          alumno: "user-graduate",
          administrador: "user-shield",
        };
        return iconos[rol] || "user";
      }

      function getColorRol(rol) {
        const colores = {
          docente: "primary",
          padre: "success",
          alumno: "warning",
          administrador: "danger",
        };
        return colores[rol] || "secondary";
      }

      // Funciones globales para eventos
      window.toggleEstadoUsuario = async function (id, estadoActual) {
        try {
          const nuevoEstado = estadoActual === "activo" ? "inactivo" : "activo";
          await authenticatedPut(`/api/usuarios/${id}`, {
            estado: nuevoEstado,
          });

          mostrarAlerta(
            `Usuario ${
              nuevoEstado === "activo" ? "activado" : "desactivado"
            } correctamente`,
            "success"
          );

          // Recargar datos
          await cargarEstadisticas();
          await cargarDocentes();
          await cargarPadres();
          await cargarUsuarios();
        } catch (error) {
          console.error("Error cambiando estado:", error);
          mostrarAlerta("Error al cambiar el estado del usuario", "danger");
        }
      };

      window.confirmarEliminarUsuario = function (id, nombre) {
        usuarioEliminando = { id, nombre };
        const modal = new bootstrap.Modal(
          document.getElementById("modalConfirmarEliminacion")
        );
        modal.show();
      };

      // Event listeners
      document.addEventListener("DOMContentLoaded", async function () {
        // Configurar fecha actual
        document.getElementById("fechaActual").textContent =
          new Date().toLocaleDateString();

        // Inicializar datos
        await inicializarUsuario();
        await cargarEstadisticas();
        await cargarDocentes();
        await cargarPadres();
        await cargarEstudiantes();
        await cargarUsuarios();
        await cargarMateriales();
      });

      // Form agregar docente
      document
        .getElementById("formAgregarDocente")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          try {
            // Normalizar y validar correo docente
            const correoDocente = document
              .getElementById("docenteCorreo")
              .value.trim()
              .toLowerCase();
            if (!/^[^\s@]+@mep\.go\.cr$/.test(correoDocente)) {
              mostrarAlerta(
                "El correo del docente debe ser del dominio @mep.go.cr",
                "danger"
              );
              return;
            }
            const data = {
              nombre: document.getElementById("docenteNombre").value,
              correo: correoDocente,
              contrase√±a: document.getElementById("docentePassword").value,
              rol: "docente",
              centroEducativo: centroEducativoId,
            };

            await authenticatedPost("/api/auth/register", data);
            mostrarAlerta("Docente creado correctamente", "success");

            // Limpiar formulario y cerrar modal
            this.reset();
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("modalAgregarDocente")
            );
            modal.hide();

            // Recargar datos
            await cargarEstadisticas();
            await cargarDocentes();
            await cargarUsuarios();
          } catch (error) {
            console.error("Error creando docente:", error);
            mostrarAlerta(error.message || "Error al crear docente", "danger");
          }
        });

      // Form agregar padre
      document
        .getElementById("formAgregarPadre")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          try {
            const submitBtn = document.querySelector(
              'button[form="formAgregarPadre"]'
            );

            // Validar contrase√±as
            const pass = document.getElementById("contrase√±aPadre").value;
            const pass2 = document.getElementById("confirmarContrase√±a").value;
            if (pass !== pass2) {
              mostrarAlerta("Las contrase√±as no coinciden", "danger");
              return;
            }

            // Normalizar
            const correo = (document.getElementById("correoPadre").value || "")
              .trim()
              .toLowerCase();
            const cedula = (document.getElementById("cedulaPadre").value || "")
              .replace(/[‚Äê‚Äë‚Äí‚Äì‚Äî‚àíÔπòÔπ£Ôºç]/g, "-")
              .replace(/\s+/g, "")
              .trim();
            const telefono = (
              document.getElementById("telefonoPadre").value || ""
            ).replace(/\D/g, "");
            const cedulaOk = /^[0-9]-[0-9]{4}-[0-9]{4}$/.test(cedula);
            const telOk = /^\d{8}$/.test(telefono);
            if (!cedulaOk) {
              mostrarAlerta(
                "La c√©dula debe tener el formato X-XXXX-XXXX",
                "danger"
              );
              return;
            }
            if (!telOk) {
              mostrarAlerta(
                "El tel√©fono debe tener exactamente 8 d√≠gitos",
                "danger"
              );
              return;
            }

            const baseData = {
              nombre: document.getElementById("nombrePadre").value,
              cedula,
              telefono,
              correo,
              contrase√±a: pass,
              direccion: document.getElementById("direccionPadre").value,
              rol: "padre",
              centroEducativo: centroEducativoId,
            };

            // Estudiantes
            const items = document.querySelectorAll(".estudiante-item");
            const estudiantes = [];
            for (const item of items) {
              const nombre = item
                .querySelector('input[name="nombreEstudiante"]')
                .value.trim();
              const ced = item
                .querySelector('input[name="cedulaEstudiante"]')
                .value.trim()
                .replace(/[‚Äê‚Äë‚Äí‚Äì‚Äî‚àíÔπòÔπ£Ôºç]/g, "-");
              const nivel = item
                .querySelector('select[name="nivelEstudiante"]')
                .value.trim();
              const grado = item
                .querySelector('select[name="gradoEstudiante"]')
                .value.trim();
              const fechaNacimiento = item.querySelector(
                'input[name="fechaNacimientoEstudiante"]'
              ).value;
              if (
                !nombre ||
                !ced ||
                !nivel ||
                !grado ||
                !/^[0-9]-[0-9]{4}-[0-9]{4}$/.test(ced)
              ) {
                mostrarAlerta(
                  "Complete correctamente los datos de los estudiantes (nombre, c√©dula, nivel y grado)",
                  "danger"
                );
                return;
              }
              estudiantes.push({
                nombre,
                cedula: ced,
                nivel,
                grado,
                fechaNacimiento,
              });
            }
            if (estudiantes.length === 0) {
              mostrarAlerta("Debe agregar al menos un estudiante", "danger");
              return;
            }

            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin me-2"></i>Registrando...';
            submitBtn.disabled = true;
            await authenticatedPost("/api/auth/registro-padre", {
              ...baseData,
              estudiantes,
            });
            mostrarAlerta(
              "Padre y estudiantes registrados correctamente",
              "success"
            );

            this.reset();
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("modalAgregarPadre")
            );
            modal.hide();
            await cargarEstadisticas();
            await cargarPadres();
            await cargarUsuarios();
          } catch (error) {
            console.error("Error creando padre:", error);
            mostrarAlerta(
              error.message || "Error al crear padre de familia",
              "danger"
            );
          } finally {
            const submitBtn = document.querySelector(
              'button[form="formAgregarPadre"]'
            );
            if (submitBtn) {
              submitBtn.innerHTML =
                '<i class="fas fa-save me-2"></i>Crear Padre';
              submitBtn.disabled = false;
            }
          }
        });

      // Din√°mica agregar/eliminar estudiante
      let contadorEstudiantesAdmin = 1;
      const maxEstudiantesAdmin = 15;
      document
        .getElementById("btnAgregarEstudiante")
        ?.addEventListener("click", function () {
          if (contadorEstudiantesAdmin >= maxEstudiantesAdmin) {
            alert(`M√°ximo ${maxEstudiantesAdmin} estudiantes permitidos`);
            return;
          }
          contadorEstudiantesAdmin++;
          const contenedor = document.getElementById("contenedorEstudiantes");
          const nuevo = document.createElement("div");
          nuevo.className = "estudiante-item border rounded p-3 mb-3";
          nuevo.setAttribute("data-index", contadorEstudiantesAdmin - 1);
          nuevo.innerHTML = `
          <div class=\"d-flex justify-content-between align-items-center mb-3\">
            <h6 class=\"mb-0\"><i class=\"fas fa-child me-2\"></i>Estudiante #${contadorEstudiantesAdmin}</h6>
            <button type=\"button\" class=\"btn btn-sm btn-outline-danger eliminar-estudiante\"><i class=\"fas fa-trash\"></i></button>
          </div>
          <div class=\"row\">
            <div class=\"col-md-6 mb-3\">
              <label class=\"form-label\">Nombre Completo *</label>
              <input type=\"text\" class=\"form-control\" name=\"nombreEstudiante\" required placeholder=\"Ej: Mar√≠a P√©rez Gonz√°lez\" />
            </div>
            <div class=\"col-md-6 mb-3\">
              <label class=\"form-label\">C√©dula del Estudiante *</label>
              <input type=\"text\" class=\"form-control\" name=\"cedulaEstudiante\" required placeholder=\"Ej: 1-2345-6789\" pattern=\"[0-9\\-]+\" />
            </div>
            <div class=\"col-md-4 mb-3\">
              <label class=\"form-label\">Nivel *</label>
              <select class=\"form-select\" name=\"nivelEstudiante\" required>
                <option value=\"\">Seleccionar nivel</option>
                <option value=\"Preescolar\">Preescolar</option>
                <option value=\"Primaria\">Primaria</option>
                <option value=\"Secundaria\">Secundaria</option>
              </select>
            </div>
            <div class=\"col-md-4 mb-3\">
              <label class=\"form-label\">Grado *</label>
              <select class=\"form-select\" name=\"gradoEstudiante\" required>
                <option value=\"\">Seleccionar grado</option>
                <option value=\"Kinder\">Kinder</option>
                <option value=\"Preparatoria\">Preparatoria</option>
                <option value=\"1¬∞\">1¬∞</option>
                <option value=\"2¬∞\">2¬∞</option>
                <option value=\"3¬∞\">3¬∞</option>
                <option value=\"4¬∞\">4¬∞</option>
                <option value=\"5¬∞\">5¬∞</option>
                <option value=\"6¬∞\">6¬∞</option>
                <option value=\"7¬∞\">7¬∞</option>
                <option value=\"8¬∞\">8¬∞</option>
                <option value=\"9¬∞\">9¬∞</option>
                <option value=\"10¬∞\">10¬∞</option>
                <option value=\"11¬∞\">11¬∞</option>
              </select>
            </div>
            <div class=\"col-md-4 mb-3\">
              <label class=\"form-label\">Fecha de Nacimiento</label>
              <input type=\"date\" class=\"form-control\" name=\"fechaNacimientoEstudiante\" />
            </div>
          </div>`;
          contenedor.appendChild(nuevo);
          nuevo
            .querySelector(".eliminar-estudiante")
            ?.addEventListener("click", () => eliminarEstudianteAdmin(nuevo));
          if (contadorEstudiantesAdmin >= maxEstudiantesAdmin) {
            document.getElementById("btnAgregarEstudiante").disabled = true;
          }
        });

      function eliminarEstudianteAdmin(elemento) {
        elemento.remove();
        contadorEstudiantesAdmin--;
        const estudiantes = document.querySelectorAll(".estudiante-item");
        estudiantes.forEach((est, index) => {
          const titulo = est.querySelector("h6");
          if (titulo)
            titulo.innerHTML = `<i class=\"fas fa-child me-2\"></i>Estudiante #${
              index + 1
            }`;
          est.setAttribute("data-index", index.toString());
        });
        const btn = document.getElementById("btnAgregarEstudiante");
        if (btn) btn.disabled = false;
      }

      document
        .getElementById("confirmarContrase√±a")
        ?.addEventListener("blur", function () {
          const c1 = document.getElementById("contrase√±aPadre").value;
          const c2 = this.value;
          if (c1 && c2 && c1 !== c2) {
            this.setCustomValidity("Las contrase√±as no coinciden");
            this.classList.add("is-invalid");
          } else {
            this.setCustomValidity("");
            this.classList.remove("is-invalid");
          }
        });

      // Form materiales
      document
        .getElementById("formMateriales")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          try {
            const updates = [];

            materiales.forEach((material) => {
              const checkbox = document.getElementById(
                `material_${material._id}`
              );
              if (checkbox) {
                updates.push({
                  id: material._id,
                  disponibleParaDocentes: checkbox.checked,
                });
              }
            });

            // Actualizar cada material
            for (const update of updates) {
              await authenticatedPut(
                `/api/materiales/${update.id}/configuracion`,
                {
                  disponibleParaDocentes: update.disponibleParaDocentes,
                }
              );
            }

            mostrarAlerta(
              "Configuraci√≥n de materiales guardada correctamente",
              "success"
            );
          } catch (error) {
            console.error("Error guardando materiales:", error);
            mostrarAlerta(
              "Error al guardar configuraci√≥n de materiales",
              "danger"
            );
          }
        });

      // Filtro de usuarios
      document
        .getElementById("filtroRol")
        .addEventListener("change", renderUsuarios);

      // Confirmar eliminaci√≥n
      document
        .getElementById("confirmarEliminar")
        .addEventListener("click", async function () {
          if (!usuarioEliminando) return;

          try {
            await authenticatedDelete(`/api/usuarios/${usuarioEliminando.id}`);
            mostrarAlerta(
              `Usuario ${usuarioEliminando.nombre} eliminado correctamente`,
              "success"
            );

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("modalConfirmarEliminacion")
            );
            modal.hide();

            // Recargar datos
            await cargarEstadisticas();
            await cargarDocentes();
            await cargarPadres();
            await cargarUsuarios();

            usuarioEliminando = null;
          } catch (error) {
            console.error("Error eliminando usuario:", error);
            mostrarAlerta("Error al eliminar usuario", "danger");
          }
        });

      // Logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", logoutUsuario);
    </script>
  </body>
</html>
