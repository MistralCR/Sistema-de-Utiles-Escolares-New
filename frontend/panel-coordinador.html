<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel Coordinador - Sistema MEP Costa Rica</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Costa Rica Theme -->
    <link rel="stylesheet" href="costa-rica-theme.css" />
    <!-- Sistema de Temas Accesibles -->
    <link rel="stylesheet" href="css/temas-accesibles.css" />

    <style>
      .header-section {
        background: linear-gradient(
          135deg,
          var(--cr-blue) 0%,
          var(--cr-blue-dark) 100%
        );
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 15px rgba(0, 43, 127, 0.2);
      }

      .config-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border: none;
        overflow: hidden;
      }

      .card-header-cr {
        background: linear-gradient(135deg, var(--cr-red) 0%, #d10e23 100%);
        color: white;
        border: none;
        padding: 1.5rem;
      }

      .form-section {
        padding: 2rem;
      }

      .logout-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
      }

      body {
        background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <!-- Header con logo MEP -->
    <div class="header-section">
      <div class="container position-relative">
        <button
          onclick="logoutUsuario()"
          class="btn btn-outline-light logout-btn"
        >
          <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
        </button>
        <div class="row align-items-center">
          <div class="col-md-2 text-center">
            <div class="mep-logo-container">
              <i class="fas fa-graduation-cap fa-3x"></i>
            </div>
          </div>
          <div class="col-md-10">
            <h1 class="h2 mb-2">
              <i class="fas fa-cog me-3"></i>Panel de Coordinación
            </h1>
            <p class="mb-0 opacity-75">
              <i class="fas fa-flag me-2"></i>Ministerio de Educación Pública -
              Costa Rica
            </p>
          </div>
        </div>
      </div>
    </div>
    <!-- Contenido principal -->
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card config-card">
            <div class="card-header-cr">
              <h3 class="h4 mb-0">
                <i class="fas fa-globe me-3"></i>Configuración Global del
                Sistema
              </h3>
            </div>

            <div class="form-section">
              <div id="mensajeGlobalInfo" class="alert alert-info d-none">
                <i class="fas fa-info-circle me-2"></i>
                <span></span>
              </div>

              <form id="configForm" class="mb-4">
                <div class="mb-4">
                  <label for="nombreSistema" class="form-label fw-bold">
                    <i class="fas fa-tag me-2 text-primary"></i>Nombre del
                    sistema
                  </label>
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    id="nombreSistema"
                    required
                    placeholder="Ej: Sistema de Útiles Escolares MEP"
                  />
                </div>

                <div class="mb-4">
                  <label for="mensajeGlobal" class="form-label fw-bold">
                    <i class="fas fa-bullhorn me-2 text-warning"></i>Mensaje
                    global
                  </label>
                  <textarea
                    class="form-control"
                    id="mensajeGlobal"
                    rows="3"
                    placeholder="Mensaje que aparecerá en todo el sistema..."
                  ></textarea>
                </div>

                <div class="mb-4">
                  <label for="logoURL" class="form-label fw-bold">
                    <i class="fas fa-image me-2 text-success"></i>Logo del
                    sistema
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="logoURL"
                    placeholder="URL del logo o código base64"
                  />
                  <div class="form-text">
                    <i class="fas fa-lightbulb me-1"></i>
                    Puede ser una URL pública o un código base64 de la imagen
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-cr-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Guardar Configuración
                  </button>
                </div>
              </form>

              <div id="successMsg" class="alert alert-success d-none">
                <i class="fas fa-check-circle me-2"></i>
                <span></span>
              </div>
              <div id="errorMsg" class="alert alert-danger d-none">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span></span>
              </div>
            </div>
          </div>

          <!-- Footer MEP -->
          <div class="text-center mt-4 text-muted">
            <p class="mb-1">
              <i class="fas fa-shield-alt me-2"></i>
              Sistema oficial del Ministerio de Educación Pública
            </p>
            <p class="mb-0">
              <i class="fas fa-heart me-1 text-danger"></i>
              Construido con orgullo costarricense
            </p>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Gestor de Temas Accesibles -->
    <script src="js/gestor-temas.js"></script>

    <script type="module">
      import {
        authenticatedGet,
        authenticatedPut,
        logoutUsuario,
        isAuthenticated,
      } from "./auth.js";

      // Verificar autenticación al cargar la página
      if (!isAuthenticated()) {
        window.location.href = "login.html";
      }

      async function cargarConfiguracion() {
        try {
          const result = await authenticatedGet("/api/configuracion");
          if (result) {
            const { data } = result;
            document.getElementById("nombreSistema").value =
              data.nombreSistema || "";
            document.getElementById("mensajeGlobal").value =
              data.mensajeGlobal || "";
            document.getElementById("logoURL").value = data.logoURL || "";
            mostrarMensajeGlobal(data.mensajeGlobal);
          }
        } catch (err) {
          mostrarError("Error de conexión: " + err.message);
        }
      }

      function mostrarMensajeGlobal(msg) {
        const info = document.getElementById("mensajeGlobalInfo");
        const span = info.querySelector("span");
        if (msg && msg.trim() !== "") {
          span.textContent = msg;
          info.classList.remove("d-none");
        } else {
          info.classList.add("d-none");
        }
      }

      function mostrarError(msg) {
        const errorMsg = document.getElementById("errorMsg");
        const span = errorMsg.querySelector("span");
        span.textContent = msg;
        errorMsg.classList.remove("d-none");
        setTimeout(() => errorMsg.classList.add("d-none"), 5000);
      }

      function mostrarExito(msg) {
        const successMsg = document.getElementById("successMsg");
        const span = successMsg.querySelector("span");
        span.textContent = msg;
        successMsg.classList.remove("d-none");
        setTimeout(() => successMsg.classList.add("d-none"), 4000);
      }

      // Función de logout global
      window.logoutUsuario = function () {
        logoutUsuario();
      };

      document
        .getElementById("configForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const submitButton = e.target.querySelector('button[type="submit"]');
          const originalText = submitButton.innerHTML;

          // Limpiar mensajes anteriores
          document.getElementById("errorMsg").classList.add("d-none");
          document.getElementById("successMsg").classList.add("d-none");

          // Mostrar estado de carga
          submitButton.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
          submitButton.disabled = true;

          const nombreSistema = document.getElementById("nombreSistema").value;
          const mensajeGlobal = document.getElementById("mensajeGlobal").value;
          const logoURL = document.getElementById("logoURL").value;

          try {
            const result = await authenticatedPut("/api/configuracion", {
              nombreSistema,
              mensajeGlobal,
              logoURL,
            });

            if (result) {
              const { data } = result;
              submitButton.innerHTML =
                '<i class="fas fa-check me-2"></i>¡Guardado!';
              mostrarExito("Configuración actualizada correctamente.");
              mostrarMensajeGlobal(data.mensajeGlobal);

              // Restaurar botón después de un momento
              setTimeout(() => {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
              }, 2000);
            }
          } catch (err) {
            mostrarError("Error de conexión: " + err.message);
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
          }
        });

      // Cargar configuración al iniciar
      cargarConfiguracion();
    </script>
    <script src="notificaciones.js"></script>
  </body>
</html>
